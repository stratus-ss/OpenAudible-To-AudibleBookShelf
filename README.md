# OpenAudible to AudioBookShelf

This script automates the process of moving audiobook files from OpenAudible or Libation to an organized folder structure and updates AudioBookShelf accordingly. It handles file organization, metadata mapping, and interaction with the AudioBookShelf API.

## Features

* **Automated File Organization:** Organizes audiobooks into a structured directory based on author and series.
* **Multiple Download Sources:** Supports both OpenAudible and Libation as download sources.
* **Metadata Mapping:** Extracts relevant metadata from JSON files generated by either OpenAudible or Libation.
* **AudioBookShelf Integration:** Scans the library, matches books with Audible, and updates AudioBookShelf.
* **File Management:** Optionally cleans up source folders after processing (for Libation).
* **Error Handling and Logging:** Provides informative logging and error messages.
* **Desktop Notifications:** Uses notify-send to display processing status.
* **Configurable:** Allows customization through command-line arguments.
* **CLI or YAML Arguments:** Accepts either CLI flags or a yaml file with arguments

## Prerequisites

* **Python 3:** Ensure Python 3 is installed on your system.
* **Required Python Packages:** Install the necessary packages using:

```bash
pip install -r requirements.txt
```

* **OpenAudible or Libation:** This script assumes you have either OpenAudible or Libation installed and configured.
* **AudioBookShelf:** You need a running instance of AudioBookShelf and its API details.
* **notify-send:** For desktop notifications.

> [!NOTE]
> Libation does not export it's library by default. Currently you need to export this yourself
> ```
> libationcli export --path $HOME/libation/libation.json --json
> ```
> In the future this may be done automatically for you

## Usage

The script is run from the command line with various arguments. Libation example:

```bash
python openaudible_to_ab.py \
  --server-url "http://audiobooks.example.com" \
  --api-token "YOUR_API_TOKEN" \
  --library-id "1cc175ca-88b9-4910-abe5-bf10b8aaa702" \
  --books-json "~/Libation/books.json" \
  --source-dir "~/Libation/Books/" \
  --dest-dir "/AudioBookShelf/library1" \
  --log-file "/tmp/openaudible_to_ab.log" \
  --file-ext ".m4b" \
  --days 7 \
  --download-program "Libation" \
  --libation-folder-cleanup True
```

OpenAudible Example:
```
python openaudible_to_ab.py \
  --server-url "http://audiobooks.example.com" \
  --api-token "YOUR_API_TOKEN" \
  --library-id "1cc175ca-88b9-4910-abe5-bf10b8aaa702" \
  --books-json "~/OpenAudible/books.json" \
  --source-dir "~/OpenAudible/books/" \
  --dest-dir "/AudioBookShelf/library1" \
  --log-file "/tmp/openaudible_to_ab.log" \
  --file-ext ".m4b" \
  --days 7 \
  --download-program "OpenAudible" 
```

> [!NOTE]
> There is an example YAML file `arguments.yaml` which is included in the repo.
> Currently the YAML looks slightly different than the CLI arguments because of the way
> I chose to rename the arguments internal to the script. This file currently looks like:
> ```
>   api-token: ""
>  books-json: ""
>  purchased_how_long_ago: 0
>  destination_book_directory: "/tmp/books/"
>  download-program: OpenAudible
>  audio_file_extension: ".m4b"
>  libation-folder-cleanup: False
>  library-id: ""
>  log-file: "/tmp/book_processing.txt"
>  server-url: ""
>  source_audio_book_directory: ""
>```

## Arguments

* **--api-token:** Your AudioBookShelf API token.
* **--books-json:** Path to the JSON file exported from OpenAudible or Libation containing book information.
* **--days:** Number of days to look back for recently purchased books (defaults to 7).
* **--dest-dir:** The destination directory where you want to organize your audiobooks.
* **--download-program:** Specify the download program - OpenAudible or Libation (defaults to OpenAudible).
* **--file-ext:** Audio file extension (defaults to .m4b).
* **--libation-folder-cleanup:** Whether to delete the source folder in Libation directory after processing (defaults to False).
* **--library-id:** The ID of your library in AudioBookShelf.
* **--log-file:** Path to the log file.
* **--server-url:** The base URL of your AudioBookShelf instance.
* **--source-dir:** The directory where your download program saves audiobook files.

## Workflow

1. **Export Book Data:** Export your OpenAudible or Libation library as a JSON file. 
> [!NOTE]
> OpenAudible does this automatically when you first login.
> Libation does not export it's library by default. Currently you need to export this yourself
> ```
> libationcli export --path $HOME/libation/libation.json --json
> ```
> In the future this may be done automatically for you
 
2. **Configuration:** Set the required command-line arguments.
3. **Execution:** Run the script. It will:
   * Process books purchased within the specified timeframe
   * Move audiobook files to the organized directory structure
   * Scan the AudioBookShelf library
   * Match the moved books in AudioBookShelf with Audible metadata
4. **Review Logs:** Check the log file for any errors or information about the processed books.

## File Organization

The script organizes audiobooks in the following structure:
```
destination_dir/
├── Author_Name/
│   ├── Series_Name/
│   │   └── Book_Title/
│   │       └── audiobook_file.m4b
│   └── Standalone_Book/
│       └── audiobook_file.m4b
└── Another_Author/
    └── ...
```

## JSON File Structure Examples

### OpenAudible JSON Format:
```json
{
  "asin": "B0123456789",
  "author": "Author Name",
  "summary": "Book summary...",
  "filename": "book_filename",
  "purchase_date": "2024-01-01",
  "series_name": "Series Name",
  "title_short": "Short Title",
  "title": "Full Book Title",
  "series_sequence": 1
}
```

### Libation JSON Format:
```json
{
  "AudibleProductId": "B0123456789",
  "AuthorNames": "Author Name",
  "Description": "Book description...",
  "Title": "Book Title",
  "Subtitle": "Book Subtitle",
  "DateAdded": "2024-01-01T12:00:00.0+00:00",
  "SeriesNames": "Series Name",
  "SeriesOrder": "1"
}
```

## Contributing

Contributions are welcome! Feel free to open issues or submit pull requests.

## License
AGPL V3